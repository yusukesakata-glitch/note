<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Note Assistant v42 (Mobile)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #f8f9fa; color: #333; -webkit-text-size-adjust: 100%; }
        .card { background: white; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        textarea, input { font-size: 16px !important; } /* スマホでズームされないサイズ */
        .btn-active:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body class="p-3 bg-gray-100 min-h-screen">

    <header class="mb-4">
        <div class="flex justify-between items-center bg-white p-3 rounded-2xl shadow-sm border-l-8 border-[#2cb696]">
            <h1 class="font-black text-[#2cb696]">NOTE v42</h1>
            <input type="password" id="apiKey" placeholder="APIキーを再入力" class="w-32 p-1 border rounded text-[10px] outline-none">
        </div>
    </header>

    <details class="card p-3 border-t-4 border-orange-400">
        <summary class="text-xs font-bold text-orange-500 uppercase tracking-widest outline-none">Settings (Tap to open)</summary>
        <div class="mt-3 space-y-2">
            <textarea id="personalInfo" rows="2" placeholder="背景情報" class="w-full p-2 bg-gray-50 rounded-lg text-sm border-none outline-none"></textarea>
            <textarea id="currentStyle" rows="2" placeholder="文体サンプル" class="w-full p-2 bg-gray-50 rounded-lg text-sm border-none outline-none"></textarea>
            <button onclick="saveAll()" class="w-full bg-orange-400 text-white py-2 rounded-xl font-bold text-xs btn-active">設定を保存</button>
        </div>
    </details>

    <div class="card p-3">
        <textarea id="tweetInput" rows="2" placeholder="いまのネタをメモ..." class="w-full p-2 bg-gray-50 rounded-xl text-sm outline-none mb-2 border-none resize-none"></textarea>
        <button onclick="postTweet()" class="w-full bg-[#1d9bf0] text-white py-3 rounded-2xl font-black btn-active shadow-lg">メモを投稿</button>
        <div id="timeline" class="mt-4 max-h-60 overflow-y-auto space-y-2"></div>
    </div>

    <div class="card p-3 border-t-4 border-[#2cb696]">
        <textarea id="mainContent" rows="8" placeholder="本文またはメモを追加..." class="w-full text-base leading-relaxed p-2 outline-none border-none"></textarea>
        <button onclick="generateDraft()" id="btn-gen" class="w-full bg-black text-white py-5 rounded-2xl font-black text-xl mt-4 shadow-2xl btn-active">
            AI構成案を作成
        </button>
    </div>

    <div id="loading" class="hidden text-center py-6 font-bold text-[#2cb696] animate-bounce">AI通信中...</div>
    <div id="resultContainer" class="hidden card p-5 border-2 border-[#2cb696] bg-white shadow-2xl mb-10">
        <div id="resultBody" class="text-base leading-relaxed whitespace-pre-wrap"></div>
    </div>

    <script>
        const STORE_KEY = 'NOTE_V42_MOBILE';
        let store = JSON.parse(localStorage.getItem(STORE_KEY)) || { tweets: [], apiKey: "", userInfo: "", style: "" };

        function saveAll() {
            store.apiKey = document.getElementById('apiKey').value;
            store.userInfo = document.getElementById('personalInfo').value;
            store.style = document.getElementById('currentStyle').value;
            localStorage.setItem(STORE_KEY, JSON.stringify(store));
            renderTimeline();
        }

        function load() {
            document.getElementById('apiKey').value = store.apiKey || "";
            document.getElementById('personalInfo').value = store.userInfo || "";
            document.getElementById('currentStyle').value = store.style || "";
            renderTimeline();
        }

        function postTweet() {
            const input = document.getElementById('tweetInput');
            if(!input.value.trim()) return;
            store.tweets.unshift({ t: input.value.trim(), d: new Date().toLocaleString('ja-JP', {month:'m', day:'d', hour:'H', minute:'M'}) });
            saveAll();
            input.value = '';
        }

        function renderTimeline() {
            const tl = document.getElementById('timeline');
            tl.innerHTML = store.tweets.map((t, i) => `
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] text-gray-400">${t.d}</span>
                        <div class="flex gap-4">
                            <button onclick="addMain(${i})" class="text-[#2cb696] font-bold text-xs">追加</button>
                            <button onclick="delT(${i})" class="text-red-300 text-xs">削除</button>
                        </div>
                    </div>
                    <p class="text-xs leading-relaxed">${t.t}</p>
                </div>
            `).join('');
        }
        function addMain(i) { document.getElementById('mainContent').value += (document.getElementById('mainContent').value ? '\n' : '') + store.tweets[i].t; }
        function delT(i) { if(confirm('削除？')) { store.tweets.splice(i,1); saveAll(); } }

        async function generateDraft() {
            const key = document.getElementById('apiKey').value;
            if(!key) return alert('APIキーを再入力してください');
            
            saveAll();
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultContainer').classList.add('hidden');

            // スマホでもNotFoundになりにくい2つのモデルで試行
            const models = ['gemini-2.0-flash-exp', 'gemini-1.5-flash-latest'];
            let success = false;

            for (let model of models) {
                try {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `背景:${store.userInfo}\n文体:${store.style}\n内容:${document.getElementById('mainContent').value}\nNote構成案を作成して。` }] }] })
                    });
                    const d = await r.json();
                    if(d.error) throw new Error(d.error.message);
                    document.getElementById('resultBody').innerText = d.candidates[0].content.parts[0].text;
                    document.getElementById('resultContainer').classList.remove('hidden');
                    document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
                    success = true; break;
                } catch (e) { console.warn(model + " 失敗"); }
            }
            if(!success) alert("スマホで通信エラー。もう一度APIキーを確認し、ChromeかSafariで開いてください。");
            document.getElementById('loading').classList.add('hidden');
        }
        load();
    </script>
</body>
</html>
