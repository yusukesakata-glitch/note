<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Assistant v28</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { note: '#2cb696' } } } }
    </script>
    <style>
        body { font-family: sans-serif; background: #f8f9fa; font-size: 14px; color: #333; }
        .card { background: white; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; padding: 15px; }
        textarea, input { width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-size: 14px; outline: none; }
        button { cursor: pointer; transition: 0.2s; font-weight: bold; }
        button:active { transform: scale(0.98); }
        .x-post { border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
<body class="p-4 max-w-2xl mx-auto">

    <div class="flex justify-between items-center mb-4">
        <h1 class="text-note font-bold text-lg">Note Assistant v28</h1>
        <input type="password" id="apiKey" placeholder="API Keyを貼り付け" class="w-48 !p-1 text-xs">
    </div>

    <div class="card border-t-4 border-orange-400">
        <h2 class="font-bold mb-2 text-orange-600">設定（背景・文体）</h2>
        <textarea id="personalInfo" rows="2" placeholder="あなたの経歴など" class="mb-2"></textarea>
        <textarea id="currentStyle" rows="2" placeholder="文体サンプル"></textarea>
    </div>

    <div class="card">
        <h2 class="font-bold mb-2 text-blue-500">タイムライン</h2>
        <div class="flex gap-2 mb-4">
            <textarea id="tweetInput" rows="2" placeholder="メモを入力..."></textarea>
            <button onclick="postTweet()" class="bg-blue-500 text-white px-6 rounded">投稿</button>
        </div>
        <div id="timeline" class="max-h-60 overflow-y-auto"></div>
    </div>

    <div class="card border-t-4 border-note shadow-lg">
        <h2 class="font-bold mb-2">執筆エディタ</h2>
        <textarea id="mainContent" rows="10" placeholder="ここに本文を書くか、上のメモを「追加」してください..." class="mb-4"></textarea>
        <button onclick="generateDraft()" id="btn-gen" class="w-full bg-gray-800 text-white py-4 rounded-xl text-lg hover:bg-black">
            AI構成案を作成する
        </button>
    </div>

    <div id="loading" class="hidden text-center py-4 font-bold text-note animate-bounce">AI通信中...</div>
    <div id="resultContainer" class="hidden card border-2 border-note bg-white shadow-2xl">
        <div id="resultBody" class="whitespace-pre-wrap leading-relaxed"></div>
    </div>

    <script>
        // データの永続化（一本化）
        const STORAGE_KEY = 'NOTE_APP_V28_FINAL';
        let store = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { tweets: [], apiKey: "", userInfo: "", style: "" };

        // 過去のデータをかき集める
        const oldKeys = ['NOTE_PRO_V27_DATA', 'NOTE_PRO_V26_DATA', 'NOTE_PRO_V25_DATA', 'n_a_final_t', 'note_t_all'];
        oldKeys.forEach(k => {
            const d = JSON.parse(localStorage.getItem(k));
            const list = Array.isArray(d) ? d : (d?.tweets || []);
            list.forEach(i => {
                const txt = i.t || i.text;
                if (txt && !store.tweets.some(t => t.t === txt)) store.tweets.push({ t: txt, d: i.d || i.date || new Date().toLocaleString() });
            });
        });

        const apiKeyEl = document.getElementById('apiKey');
        const personalInfo = document.getElementById('personalInfo');
        const currentStyle = document.getElementById('currentStyle');
        const mainContent = document.getElementById('mainContent');

        // 初期値セット
        apiKeyEl.value = store.apiKey || '';
        personalInfo.value = store.userInfo || '';
        currentStyle.value = store.style || '';

        function save() {
            store.apiKey = apiKeyEl.value;
            store.userInfo = personalInfo.value;
            store.style = currentStyle.value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
        }

        function postTweet() {
            const input = document.getElementById('tweetInput');
            if(!input.value.trim()) return;
            store.tweets.unshift({ t: input.value.trim(), d: new Date().toLocaleString('ja-JP') });
            save();
            input.value = '';
            renderTimeline();
        }

        function renderTimeline() {
            const tl = document.getElementById('timeline');
            tl.innerHTML = store.tweets.map((t, i) => `
                <div class="x-post">
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>${t.d}</span>
                        <div class="flex gap-2">
                            <button onclick="addEd(${i})" class="text-note">追加</button>
                            <button onclick="delT(${i})" class="text-red-400">削除</button>
                        </div>
                    </div>
                    <p class="text-sm">${t.t}</p>
                </div>
            `).join('');
        }
        function addEd(i) { mainContent.value += (mainContent.value ? '\n' : '') + store.tweets[i].t; }
        function delT(i) { store.tweets.splice(i,1); save(); renderTimeline(); }

        // --- AI通信：2025年12月時点の最新・最安定エンドポイント ---
        async function callAI(promptText) {
            const key = apiKeyEl.value;
            if(!key) return alert('APIキーを入力してください');
            
            save();
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultContainer').classList.add('hidden');

            try {
                // モデル名の指定を最新の推奨形式「gemini-1.5-flash-latest」に変更
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }]
                    })
                });

                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;

            } catch (e) {
                alert('エラー発生: ' + e.message + '\n\n※このエラーが出る場合は、Google AI Studioで新しいAPIキーを「新しいプロジェクト」で作って貼り替えてください。');
                return null;
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function generateDraft() {
            const prompt = `あなたはプロのNoteライターです。
【背景情報】${store.userInfo}
【文体サンプル】${store.style}
上記を踏まえ、以下の内容を元にNoteの構成案を作成してください。絵文字は使わず、自然な日本語で。
【内容】${mainContent.value}`;
            
            const result = await callAI(prompt);
            if(result) {
                document.getElementById('resultBody').innerText = result;
                document.getElementById('resultContainer').classList.remove('hidden');
                document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
            }
        }

        renderTimeline();
    </script>
</body>
</html>
