<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Final Connection v40</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-4 max-w-xl mx-auto bg-gray-50 flex items-center min-h-screen font-sans">
    <div class="bg-white p-8 rounded-3xl shadow-2xl border-t-8 border-blue-500 w-full">
        <h1 class="font-bold text-gray-400 mb-6 text-center text-xs uppercase tracking-widest">v40: Dual Connection Mode</h1>
        <input type="password" id="apiKey" placeholder="AI Studioのキーを貼る" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-4 outline-none focus:border-blue-500 font-mono">
        <textarea id="mainContent" rows="4" class="w-full p-4 border-2 border-gray-100 rounded-2xl mb-4 outline-none" placeholder="テスト用入力...">こんにちは。接続テストです。成功、と返してください。</textarea>
        <button onclick="smartConnect()" id="btn" class="w-full bg-blue-500 text-white py-5 rounded-2xl font-bold text-xl hover:bg-blue-600 active:scale-95 transition-all">AIを起動する</button>
        <div id="st" class="mt-4 text-center text-[10px] font-bold text-gray-400 italic"></div>
        <div id="res" class="mt-4 p-5 bg-blue-50 text-blue-800 rounded-2xl text-sm hidden border border-blue-100"></div>
    </div>

    <script>
        async function smartConnect() {
            const k = document.getElementById('apiKey').value;
            if(!k) return alert('キーを貼ってください');
            const btn = document.getElementById('btn');
            const st = document.getElementById('st');
            const res = document.getElementById('res');
            
            btn.disabled = true; st.innerText = "Connecting..."; res.classList.add('hidden');

            // 今動く可能性が最も高い2つのモデルを順番に試す
            const models = ['gemini-2.0-flash-exp', 'gemini-1.5-flash-latest'];
            
            for (let model of models) {
                st.innerText = `Trying ${model}...`;
                try {
                    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${k}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: document.getElementById('mainContent').value }] }] })
                    });
                    const d = await r.json();
                    if(d.error) throw new Error(d.error.message);
                    
                    res.innerText = `【成功】${model}で接続しました。\n\n` + d.candidates[0].content.parts[0].text;
                    res.classList.remove('hidden');
                    st.innerText = "SUCCESS!";
                    btn.disabled = false;
                    return;
                } catch (e) {
                    console.warn(model + " failed: " + e.message);
                }
            }
            alert("全モデルでNotFoundになりました。AI StudioのPlaygroundでAIと会話ができるか再度確認してください。");
            btn.disabled = false;
            st.innerText = "FAILED";
        }
    </script>
</body>
</html>
